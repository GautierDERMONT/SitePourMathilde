<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Mathilde JOYEUX</title>
  <style>
    body { margin: 0; padding: 0; }
    #cms-loading { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: white; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 9999; 
    }
  </style>
</head>
<body>
  <div id="cms-loading">
    <div style="text-align: center;">
      <h2>Chargement de l'interface d'administration...</h2>
      <p>Veuillez patienter</p>
    </div>
  </div>

  <!-- Chargement séquentiel strict -->
  <script>
    // Charger Netlify Identity d'abord
    const identityScript = document.createElement('script');
    identityScript.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
    identityScript.onload = function() {
      console.log('Netlify Identity loaded');
      
      // Initialiser Identity
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', function(user) {
          console.log('Identity initialized', user ? 'with user' : 'no user');
          
          // Maintenant charger Decap CMS
          const cmsScript = document.createElement('script');
          cmsScript.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
          cmsScript.onload = function() {
            console.log('Decap CMS loaded');
            
            // Attendre que le DOM soit complètement prêt
            setTimeout(function() {
              if (window.CMS) {
                try {
                  window.CMS.init();
                  console.log('CMS initialized successfully');
                  
                  // Masquer l'écran de chargement
                  setTimeout(function() {
                    const loading = document.getElementById('cms-loading');
                    if (loading) loading.style.display = 'none';
                  }, 1000);
                  
                } catch (error) {
                  console.error('CMS init error:', error);
                  document.getElementById('cms-loading').innerHTML = 
                    '<div style="color: red; text-align: center;"><h3>Erreur</h3><p>' + error.message + '</p></div>';
                }
              }
            }, 500);
          };
          
          document.head.appendChild(cmsScript);
        });
        
        window.netlifyIdentity.init();
      }
    };
    
    document.head.appendChild(identityScript);
  </script>
</body>
</html>